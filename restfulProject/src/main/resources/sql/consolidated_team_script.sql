-- ==================================================
-- [통합 SQL 스크립트 - Final Version]
-- 팀원들의 변경사항(ALTER)을 모두 반영하여 초기 테이블 생성(CREATE)부터 수행하는 스크립트입니다.
-- 기존 객체를 삭제하고 새로 생성하므로, 데이터가 초기화됩니다.
-- ==================================================

-- 1. 기존 객체 삭제 (청소)
BEGIN
    FOR c IN (SELECT table_name FROM user_tables) LOOP
        EXECUTE IMMEDIATE 'DROP TABLE ' || c.table_name || ' CASCADE CONSTRAINTS';
    END LOOP;
    FOR s IN (SELECT sequence_name FROM user_sequences) LOOP
        EXECUTE IMMEDIATE 'DROP SEQUENCE ' || s.sequence_name;
    END LOOP;
END;
/

-- 2. 시퀀스 생성
CREATE SEQUENCE MEMBER_SEQ NOCACHE NOCYCLE;
CREATE SEQUENCE SEQ_WALLET_ID NOCACHE;
CREATE SEQUENCE SEQ_ITEM_ID NOCACHE NOCYCLE;
CREATE SEQUENCE SEQ_UI_ID NOCACHE NOCYCLE;
CREATE SEQUENCE POST_ID_SEQ NOCACHE NOCYCLE;
CREATE SEQUENCE FILES_ID_SEQ NOCACHE NOCYCLE;
CREATE SEQUENCE REPLY_ID_SEQ NOCACHE NOCYCLE;
CREATE SEQUENCE REPORTS_ID_SEQ NOCACHE NOCYCLE;
CREATE SEQUENCE PL_ID_SEQ NOCACHE NOCYCLE;
CREATE SEQUENCE RL_ID_SEQ NOCACHE NOCYCLE;

-- 시퀀스 추가 (ATTENDANCE용)
CREATE SEQUENCE SEQ_ATTENDANCE_ID;

-- 3. 테이블 생성 (모든 ALTER 반영됨)

-- [MEMBER] 회원
CREATE TABLE MEMBER (
    MEMBER_ID           NUMBER NOT NULL,
    LOGIN_ID            VARCHAR2(50 BYTE) NOT NULL,
    PASSWORD            VARCHAR2(100 BYTE) NOT NULL,
    NAME                VARCHAR2(30 BYTE) NOT NULL,
    BIRTHDAY            VARCHAR2(10 BYTE),
    GENDER              VARCHAR2(10 BYTE),
    ADDRESS             VARCHAR2(200 BYTE),
    STATUS              VARCHAR2(20 BYTE),
    QUIZ_ATTEMPT_COUNT  NUMBER DEFAULT 0,
    QUIZ_CORRECT_COUNT  NUMBER DEFAULT 0,
    CREATED_AT          DATE DEFAULT SYSDATE,
    UPDATE_AT           DATE DEFAULT SYSDATE,
    -- 추가된 컬럼
    PROFILE_IMAGE_URL   CLOB,
    STATUS_MESSAGE      VARCHAR2(255),
    IS_ONLINE           NUMBER(1) DEFAULT 0,
    CONSTRAINT PK_MEMBER PRIMARY KEY (MEMBER_ID),
    CONSTRAINT CHK_MEMBER_ONLINE CHECK (IS_ONLINE IN (0, 1))
);
COMMENT ON COLUMN MEMBER.MEMBER_ID IS '회원 고유 ID (PK)';
COMMENT ON COLUMN MEMBER.PROFILE_IMAGE_URL IS '프로필 사진 저장 경로(S3)';
COMMENT ON COLUMN MEMBER.STATUS_MESSAGE IS '사용자 상태 메시지';
COMMENT ON COLUMN MEMBER.IS_ONLINE IS '실시간 접속 상태 (0:OFF, 1:ON)';

-- [POINT_WALLET] 포인트 지갑
CREATE TABLE POINT_WALLET (
    WALLET_ID           NUMBER NOT NULL,
    MEMBER_ID           NUMBER NOT NULL,
    NOW_POINT           NUMBER DEFAULT 0,
    TOTAL_EARNED_POINT  NUMBER DEFAULT 0,
    TOTAL_SPENT_POINT   NUMBER DEFAULT 0,
    UPDATED_AT          DATE DEFAULT SYSDATE,
    CONSTRAINT PK_POINT_WALLET PRIMARY KEY (WALLET_ID),
    CONSTRAINT FK_WALLET_MEMBER FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE
);

-- [ECO_SHOP] 친환경 상점
CREATE TABLE ECO_SHOP (
    SHOP_ID     NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    NAME        VARCHAR2(255),
    ADDRESS     VARCHAR2(255),
    PHONE       VARCHAR2(50),
    LAT         NUMBER,
    LNG         NUMBER,
    IS_ACTIVE   NUMBER(1) DEFAULT 1,
    CREATED_AT  DATE DEFAULT SYSDATE,
    UPDATED_AT  DATE DEFAULT SYSDATE,
    ESC_ID      NUMBER,
    -- 추가된 컬럼
    AVG_RATING  NUMBER(3,2) DEFAULT 0,
    CONTS_ID    VARCHAR2(50),
    CONSTRAINT PK_ECO_SHOP PRIMARY KEY (SHOP_ID)
);
COMMENT ON COLUMN ECO_SHOP.AVG_RATING IS '평균 평점';
COMMENT ON COLUMN ECO_SHOP.CONTS_ID IS '컨텐츠 ID';

-- [ECO_SHOP_CATEGORY] 상점 카테고리
CREATE TABLE ECO_SHOP_CATEGORY (
    ESC_ID      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    NAME        VARCHAR2(100),
    CODE        VARCHAR2(50),
    DESCRIPTION VARCHAR2(255),
    -- 추가된 컬럼
    CONTS_ID    VARCHAR2(50),
    CONSTRAINT PK_ECO_SHOP_CATEGORY PRIMARY KEY (ESC_ID)
);
COMMENT ON COLUMN ECO_SHOP_CATEGORY.CONTS_ID IS '컨텐츠 ID';

-- [ECO_SHOP_REVIEW] 상점 리뷰
CREATE TABLE ECO_SHOP_REVIEW (
    ESR_ID      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    SHOP_ID     NUMBER NOT NULL,
    RATING      NUMBER NOT NULL,
    CONTENT     CLOB,
    CREATED_AT  DATE DEFAULT SYSDATE,
    UPDATED_AT  DATE DEFAULT SYSDATE,
    -- 추가/수정된 컬럼
    MEMBER_ID   NUMBER NOT NULL,
    CONSTRAINT PK_ECO_SHOP_REVIEW PRIMARY KEY (ESR_ID),
    CONSTRAINT FK_REVIEW_SHOP FOREIGN KEY (SHOP_ID) REFERENCES ECO_SHOP(SHOP_ID) ON DELETE CASCADE,
    CONSTRAINT FK_REVIEW_MEMBER FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE
);

-- [ITEM] 아이템
CREATE TABLE ITEM (
    ITEM_ID     NUMBER NOT NULL,
    NAME        VARCHAR2(100 BYTE) NOT NULL,
    DESCRIPTION CLOB,
    PRICE       NUMBER,
    RARITY      VARCHAR2(30 BYTE),
    -- IMAGE_URL 삭제됨
    IS_ON_SALE  CHAR(1 BYTE) DEFAULT 'Y',
    CATEGORY    VARCHAR2(50 BYTE),
    CREATED_AT  DATE DEFAULT SYSDATE,
    UPDATED_AT  DATE,
    CONSTRAINT PK_ITEM PRIMARY KEY (ITEM_ID)
);

-- [USER_ITEMS] 보유 아이템
CREATE TABLE USER_ITEMS (
    UI_ID       NUMBER NOT NULL,
    ITEM_ID     NUMBER NOT NULL,
    USER_ID     NUMBER NOT NULL,
    ACQUIRED_AT DATE DEFAULT SYSDATE,
    IS_EQUIPPED CHAR(1 BYTE) DEFAULT 'N',
    EQUIPPED_AT DATE,
    -- QUANTITY 삭제됨
    -- 추가된 컬럼
    PRICE       NUMBER NOT NULL,
    CATEGORY    VARCHAR2(30 BYTE),
    CONSTRAINT PK_USER_ITEMS PRIMARY KEY (UI_ID),
    CONSTRAINT FK_UI_ITEM FOREIGN KEY (ITEM_ID) REFERENCES ITEM(ITEM_ID) ON DELETE CASCADE,
    CONSTRAINT FK_UI_USER FOREIGN KEY (USER_ID) REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE
);
COMMENT ON COLUMN USER_ITEMS.PRICE IS '가격';
COMMENT ON COLUMN USER_ITEMS.CATEGORY IS '카테고리';

-- [COMMUNITY_POST] 커뮤니티 게시글
CREATE TABLE COMMUNITY_POST (
    POST_ID         NUMBER NOT NULL,
    MEMBER_ID       NUMBER NOT NULL,
    TITLE           VARCHAR2(200 BYTE) NOT NULL,
    CONTENT         CLOB NOT NULL,
    VIEW_COUNT      NUMBER DEFAULT 0,
    LIKE_COUNT      NUMBER DEFAULT 0,
    COMMENT_COUNT   NUMBER DEFAULT 0,
    HAS_FILES       NUMBER(1) DEFAULT 0,
    REPORT_COUNT    NUMBER DEFAULT 0,
    CREATED_AT      DATE DEFAULT SYSDATE,
    UPDATED_AT      DATE DEFAULT SYSDATE,
    CATEGORY        VARCHAR2(30 BYTE),
    -- 추가된 컬럼
    ORIGIN_NAME     VARCHAR2(255 BYTE),
    CHANGE_NAME     VARCHAR2(255 BYTE),
    CONSTRAINT PK_COMMUNITY_POST PRIMARY KEY (POST_ID),
    CONSTRAINT FK_POST_MEMBER FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE
);
COMMENT ON COLUMN COMMUNITY_POST.ORIGIN_NAME IS '파일 원본명';
COMMENT ON COLUMN COMMUNITY_POST.CHANGE_NAME IS '파일 수정명';

-- [COMMUNITY_REPLY] 커뮤니티 댓글
CREATE TABLE COMMUNITY_REPLY (
    REPLY_ID        NUMBER NOT NULL,
    POST_ID         NUMBER NOT NULL,
    MEMBER_ID       NUMBER NOT NULL,
    PARENT_REPLY_ID NUMBER,
    CONTENT         CLOB NOT NULL,
    LIKE_COUNT      NUMBER DEFAULT 0,
    REPORT_COUNT    NUMBER DEFAULT 0,
    CREATED_AT      DATE DEFAULT SYSDATE,
    UPDATED_AT      DATE DEFAULT SYSDATE,
    -- 추가된 컬럼
    GROUP_ID        NUMBER NOT NULL,
    DEPTH           NUMBER DEFAULT 0,
    STATUS          VARCHAR2(1 BYTE) DEFAULT 'Y' NOT NULL,
    CONSTRAINT PK_COMMUNITY_REPLY PRIMARY KEY (REPLY_ID),
    CONSTRAINT FK_REPLY_POST FOREIGN KEY (POST_ID) REFERENCES COMMUNITY_POST(POST_ID) ON DELETE CASCADE,
    CONSTRAINT FK_REPLY_MEMBER FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE,
    CONSTRAINT CK_CR_STATUS CHECK (STATUS IN ('Y', 'N'))
);
COMMENT ON COLUMN COMMUNITY_REPLY.GROUP_ID IS '댓글 그룹 번호';
COMMENT ON COLUMN COMMUNITY_REPLY.DEPTH IS '계층 깊이 (0: 댓글, 1 이상: 대댓글)';
COMMENT ON COLUMN COMMUNITY_REPLY.STATUS IS '삭제 상태 (Y: 정상, N: 삭제됨)';

-- [POST_FILES] 첨부파일
CREATE TABLE POST_FILES (
    FILES_ID    NUMBER NOT NULL,
    POST_ID     NUMBER NOT NULL,
    MEMBER_ID   NUMBER NOT NULL,
    URL         VARCHAR2(1000 BYTE) NOT NULL,
    TYPE        VARCHAR2(100 BYTE),
    FILE_SIZE   NUMBER DEFAULT 0,
    CREATED_AT  DATE DEFAULT SYSDATE,
    -- 추가된 컬럼 (NAME 삭제됨)
    ORIGIN_NAME VARCHAR2(255 BYTE),
    CHANGE_NAME VARCHAR2(255 BYTE),
    CONSTRAINT PK_POST_FILES PRIMARY KEY (FILES_ID),
    CONSTRAINT FK_FILES_POST FOREIGN KEY (POST_ID) REFERENCES COMMUNITY_POST(POST_ID) ON DELETE CASCADE,
    CONSTRAINT FK_FILES_MEMBER FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE
);

-- [COMMUNITY_POST_LIKES] 게시글 좋아요
CREATE TABLE COMMUNITY_POST_LIKES (
    PL_ID       NUMBER NOT NULL,
    POST_ID     NUMBER NOT NULL,
    MEMBER_ID   NUMBER NOT NULL,
    CREATED_AT  DATE DEFAULT SYSDATE,
    -- 추가된 컬럼
    STATUS      VARCHAR2(1) DEFAULT 'Y' NOT NULL,
    CONSTRAINT PK_POST_LIKES PRIMARY KEY (PL_ID),
    CONSTRAINT FK_PL_POST FOREIGN KEY (POST_ID) REFERENCES COMMUNITY_POST(POST_ID) ON DELETE CASCADE,
    CONSTRAINT FK_PL_MEMBER FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE,
    CONSTRAINT UK_POST_MEMBER UNIQUE (POST_ID, MEMBER_ID)
);

-- [COMMUNITY_REPLY_LIKES] 댓글 좋아요
CREATE TABLE COMMUNITY_REPLY_LIKES (
    RL_ID       NUMBER NOT NULL,
    REPLY_ID    NUMBER NOT NULL,
    POST_ID     NUMBER NOT NULL,
    MEMBER_ID   NUMBER NOT NULL,
    CREATED_AT  DATE DEFAULT SYSDATE,
    -- 추가된 컬럼
    STATUS      VARCHAR2(1) DEFAULT 'Y' NOT NULL,
    CONSTRAINT PK_REPLY_LIKES PRIMARY KEY (RL_ID),
    CONSTRAINT FK_RL_REPLY FOREIGN KEY (REPLY_ID) REFERENCES COMMUNITY_REPLY(REPLY_ID) ON DELETE CASCADE,
    CONSTRAINT FK_RL_POST FOREIGN KEY (POST_ID) REFERENCES COMMUNITY_POST(POST_ID) ON DELETE CASCADE,
    CONSTRAINT FK_RL_MEMBER FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE,
    CONSTRAINT UK_REPLY_MEMBER UNIQUE (REPLY_ID, MEMBER_ID)
);


-- [CHAT_ROOM] 채팅방
CREATE TABLE CHAT_ROOM (
    CHAT_ROOM_ID         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    TITLE                VARCHAR2(100),
    ROOM_TYPE            VARCHAR2(20) NOT NULL,
    LAST_MESSAGE_CONTENT CLOB,
    LAST_MESSAGE_AT      TIMESTAMP,
    CREATED_AT           TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT PK_CHAT_ROOM PRIMARY KEY (CHAT_ROOM_ID), 
    CONSTRAINT CHK_ROOM_TYPE CHECK (ROOM_TYPE IN ('SINGLE', 'GROUP'))
);

-- [CHAT_ROOM_USER] 채팅 참여자
CREATE TABLE CHAT_ROOM_USER (
    CHAT_ROOM_USER_ID    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    CHAT_ROOM_ID         NUMBER NOT NULL,
    MEMBER_ID            NUMBER NOT NULL,
    LAST_READ_MESSAGE_ID NUMBER DEFAULT 0,
    JOINED_AT            TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT PK_CHAT_ROOM_USER PRIMARY KEY (CHAT_ROOM_USER_ID),
    CONSTRAINT FK_CRU_ROOM FOREIGN KEY (CHAT_ROOM_ID) REFERENCES CHAT_ROOM(CHAT_ROOM_ID) ON DELETE CASCADE, 
    CONSTRAINT FK_CRU_MEMBER FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE
);
CREATE INDEX IDX_ROOM_MEMBER_COMP ON CHAT_ROOM_USER(CHAT_ROOM_ID, MEMBER_ID);

-- [CHAT_MESSAGE] 채팅 메시지
CREATE TABLE CHAT_MESSAGE (
    MESSAGE_ID   NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    CHAT_ROOM_ID NUMBER NOT NULL,
    SENDER_ID    NUMBER NOT NULL,
    CONTENT      CLOB NOT NULL,
    MESSAGE_TYPE VARCHAR2(20) NOT NULL,
    CREATED_AT   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT PK_CHAT_MESSAGE PRIMARY KEY (MESSAGE_ID),
    CONSTRAINT FK_MSG_ROOM FOREIGN KEY (CHAT_ROOM_ID) REFERENCES CHAT_ROOM(CHAT_ROOM_ID) ON DELETE CASCADE,
    CONSTRAINT FK_MSG_SENDER FOREIGN KEY (SENDER_ID) REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE,
    CONSTRAINT CHK_MSG_TYPE CHECK (MESSAGE_TYPE IN ('TEXT', 'IMAGE', 'EMOJI', 'ENTER', 'LEAVE'))
);

-- [MESSAGE_REACTION] 메시지 리액션
CREATE TABLE MESSAGE_REACTION (
    REACTION_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    MESSAGE_ID  NUMBER NOT NULL,
    MEMBER_ID   NUMBER NOT NULL,
    EMOJI_TYPE  VARCHAR2(50) NOT NULL,
    CONSTRAINT PK_MESSAGE_REACTION PRIMARY KEY (REACTION_ID),
    CONSTRAINT FK_REACTION_MSG FOREIGN KEY (MESSAGE_ID) REFERENCES CHAT_MESSAGE(MESSAGE_ID) ON DELETE CASCADE,
    CONSTRAINT FK_REACTION_MEMBER FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE,
    CONSTRAINT UQ_MEMBER_REACTION UNIQUE (MESSAGE_ID, MEMBER_ID)
);


-- [ATTENDANCE] 출석 (제가 추가해드리는 테이블)
CREATE TABLE ATTENDANCE (
    ATTENDANCE_ID NUMBER PRIMARY KEY,
    USER_ID NUMBER NOT NULL,
    ATTENDANCE_DATE DATE DEFAULT SYSDATE NOT NULL,
    CONSECUTIVE_DAYS NUMBER DEFAULT 1 NOT NULL,
    POINTS_EARNED NUMBER DEFAULT 0 NOT NULL,
    CONSTRAINT FK_ATTENDANCE_USER FOREIGN KEY (USER_ID) REFERENCES MEMBER(MEMBER_ID)
);


-- 4. 데이터 삽입 (ECO_SHOP_CATEGORY)
INSERT INTO ECO_SHOP_CATEGORY (NAME, CODE, DESCRIPTION, CONTS_ID) VALUES ('(친환경)자전거 도로', '', '자전거 도로 카테고리', '1657588761062');
INSERT INTO ECO_SHOP_CATEGORY (NAME, CODE, DESCRIPTION, CONTS_ID) VALUES ('[착한소비] 개인 컵 할인 카페', '', '개인 컵 할인 카페', '1693986134109');
INSERT INTO ECO_SHOP_CATEGORY (NAME, CODE, DESCRIPTION, CONTS_ID) VALUES ('[착한소비]제로웨이스트상점', '', '제로웨이스트 상점', '11103395');
INSERT INTO ECO_SHOP_CATEGORY (NAME, CODE, DESCRIPTION, CONTS_ID) VALUES ('녹색교통지역', '', '녹색교통지역', '11101339');
INSERT INTO ECO_SHOP_CATEGORY (NAME, CODE, DESCRIPTION, CONTS_ID) VALUES ('우리동네약수터', '', '우리동네약수터', '100578');
INSERT INTO ECO_SHOP_CATEGORY (NAME, CODE, DESCRIPTION, CONTS_ID) VALUES ('[성북] 도심공원 즐기기', '', '도심공원 즐기기', '1765960271640');
INSERT INTO ECO_SHOP_CATEGORY (NAME, CODE, DESCRIPTION, CONTS_ID) VALUES ('재활용 정거장', '', '재활용 정거장', '1730359504536');

COMMIT;


-- 5. 트리거 생성
-- [TRG_UPDATE_AVG_RATING]
CREATE OR REPLACE TRIGGER TRG_UPDATE_AVG_RATING
AFTER INSERT OR UPDATE OR DELETE ON ECO_SHOP_REVIEW
FOR EACH ROW
DECLARE
    PRAGMA AUTONOMOUS_TRANSACTION;
    V_SHOP_ID NUMBER;
BEGIN
    IF DELETING THEN V_SHOP_ID := :OLD.SHOP_ID;
    ELSE V_SHOP_ID := :NEW.SHOP_ID;
    END IF;

    UPDATE ECO_SHOP
    SET AVG_RATING = (
        SELECT NVL(ROUND(AVG(RATING), 2), 0)
        FROM ECO_SHOP_REVIEW
        WHERE SHOP_ID = V_SHOP_ID
    )
    WHERE SHOP_ID = V_SHOP_ID;

    COMMIT;
END;
/

-- [TRG_MEMBER_REGISTERED]
CREATE OR REPLACE TRIGGER TRG_MEMBER_REGISTERED
AFTER INSERT ON MEMBER
FOR EACH ROW
BEGIN
    INSERT INTO POINT_WALLET (
        WALLET_ID,
        MEMBER_ID,
        NOW_POINT,
        TOTAL_EARNED_POINT,
        TOTAL_SPENT_POINT,
        UPDATED_AT
    ) VALUES (
        SEQ_WALLET_ID.NEXTVAL,
        :NEW.MEMBER_ID,
        2000,
        2000,
        0,
        SYSDATE
    );
END;
/

-- 퀘스트 테이블
CREATE TABLE QUEST (
    QUEST_NO    NUMBER NOT NULL,
    QUEST_TITLE VARCHAR2(300 BYTE) NOT NULL,
    POINT       NUMBER DEFAULT 0,
    CATEGORY    VARCHAR2(50 BYTE),
    CREATED_AT  DATE DEFAULT SYSDATE,
    CONSTRAINT PK_QUEST PRIMARY KEY (QUEST_NO)
);

-- 퀘스트 시퀀스
CREATE SEQUENCE SEQ_QUEST_NO
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- 퀘스트 수행 내역 (인증) 테이블
CREATE TABLE QUEST_HISTORY (
    HISTORY_ID  NUMBER NOT NULL,
    MEMBER_ID   NUMBER NOT NULL,
    QUEST_NO    NUMBER NOT NULL,
    IMAGE_URL   VARCHAR2(500 BYTE),
    STATUS      VARCHAR2(1 BYTE) DEFAULT 'N', -- N:대기, Y:승인, R:거절
    CREATED_AT  DATE DEFAULT SYSDATE,
    CONSTRAINT PK_QUEST_HISTORY PRIMARY KEY (HISTORY_ID),
    CONSTRAINT FK_QH_MEMBER FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE,
    CONSTRAINT FK_QH_QUEST FOREIGN KEY (QUEST_NO) REFERENCES QUEST(QUEST_NO) ON DELETE CASCADE
);

-- 퀘스트 내역 시퀀스
CREATE SEQUENCE SEQ_QUEST_HISTORY_NO
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- [QUIZ] 퀴즈
CREATE TABLE QUIZ (
    QUIZ_NO         NUMBER NOT NULL,
    QUIZ_QUESTION   VARCHAR2(500 BYTE) NOT NULL,
    QUIZ_ANSWER     NUMBER NOT NULL,
    QUIZ_EXPLANATION VARCHAR2(1000 BYTE),
    POINT           NUMBER DEFAULT 10,
    DIFFICULTY      VARCHAR2(20 BYTE), -- Easy, Normal, Hard
    OPTION1         VARCHAR2(200 BYTE),
    OPTION2         VARCHAR2(200 BYTE),
    OPTION3         VARCHAR2(200 BYTE),
    OPTION4         VARCHAR2(200 BYTE),
    CONSTRAINT PK_QUIZ PRIMARY KEY (QUIZ_NO)
);

CREATE SEQUENCE SEQ_QUIZ_NO
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;


-- 초기 퀘스트 데이터 (Daily 5개)
INSERT INTO QUEST (QUEST_NO, QUEST_TITLE, POINT, CATEGORY) VALUES (SEQ_QUEST_NO.NEXTVAL, '텀블러 사용 인증하기', 100, '에너지 절약');
INSERT INTO QUEST (QUEST_NO, QUEST_TITLE, POINT, CATEGORY) VALUES (SEQ_QUEST_NO.NEXTVAL, '대중교통 이용하기', 150, '탄소 줄이기');
INSERT INTO QUEST (QUEST_NO, QUEST_TITLE, POINT, CATEGORY) VALUES (SEQ_QUEST_NO.NEXTVAL, '장바구니 사용하기', 100, '제로 웨이스트');
INSERT INTO QUEST (QUEST_NO, QUEST_TITLE, POINT, CATEGORY) VALUES (SEQ_QUEST_NO.NEXTVAL, '안 쓰는 플러그 뽑기', 50, '에너지 절약');
INSERT INTO QUEST (QUEST_NO, QUEST_TITLE, POINT, CATEGORY) VALUES (SEQ_QUEST_NO.NEXTVAL, '분리수거 철저히 하기', 100, '재활용');

-- 테스트 유저 (ID: 1) 추가
INSERT INTO MEMBER (MEMBER_ID, LOGIN_ID, PASSWORD, NAME, BIRTHDAY, GENDER, ADDRESS, STATUS, IS_ONLINE, CREATED_AT) 
VALUES (1, 'testuser', '1234', '테스트유저', '2000-01-01', 'M', '서울시 강남구', 'Y', 1, SYSDATE);

COMMIT;


-- [TRG_UPDATE_TOTAL_POINTS]
CREATE OR REPLACE TRIGGER TRG_UPDATE_TOTAL_POINTS
BEFORE UPDATE OF NOW_POINT ON POINT_WALLET
FOR EACH ROW
DECLARE
    V_DIFF NUMBER;
BEGIN
    V_DIFF := :NEW.NOW_POINT - :OLD.NOW_POINT;
    IF V_DIFF > 0 THEN
        :NEW.TOTAL_EARNED_POINT := :OLD.TOTAL_EARNED_POINT + V_DIFF;
    ELSIF V_DIFF < 0 THEN
        :NEW.TOTAL_SPENT_POINT := :OLD.TOTAL_SPENT_POINT + ABS(V_DIFF);
    END IF;
    :NEW.UPDATED_AT := SYSDATE;
END;
/
