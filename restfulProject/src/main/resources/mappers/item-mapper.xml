<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="itemMapper">
  	
  	<!-- 포인트상점 아이템 조회 매퍼 -->
  	<select id="storeItem" resultType="ItemVO">
  		SELECT *
  		FROM ITEM
  	</select>
  	
  	<!-- 포인트상점 보유중인 아이템 조회 매퍼 -->
  	<select id="storeMyItem"
	        parameterType="int"
	        resultType="UserItemList">
	
	    SELECT
	        UI.UI_ID,
	        UI.ITEM_ID,
	        UI.USER_ID,
	        UI.PRICE AS BUY_PRICE,
	        UI.CATEGORY AS USER_CATEGORY,
	        UI.IS_EQUIPPED,
	        UI.ACQUIRED_AT,
	        UI.EQUIPPED_AT,
	
	        I.NAME,
	        I.DESCRIPTION,
	        I.RARITY,
	        I.CATEGORY AS ITEM_CATEGORY
	
	    FROM USER_ITEMS UI
	    JOIN ITEM I
	        ON UI.ITEM_ID = I.ITEM_ID
	    WHERE UI.USER_ID = #{memberId}
	
	</select>
	
	<!-- 전체 아이템 중 특정 하나 조회 -->
	<select id="itemsDetail" parameterType="int" resultType="ItemVO">
		SELECT ITEM_ID,
				NAME,
				DESCRIPTION,
				PRICE,
				RARITY,
				IS_ON_SALE,
				CATEGORY,
				CREATED_AT,
				UPDATED_AT
		FROM ITEM
		WHERE ITEM_ID = #{itemId}
	</select>
	
	<!-- 보유 아이템 중 특정 하나 조회 -->
	<select id="myItemsDetail" parameterType="map" resultType="UserItemList">
		SELECT 
	        I.ITEM_ID,
	        I.NAME,
	        I.DESCRIPTION,
	        I.PRICE,
	        I.RARITY,
	        I.IS_ON_SALE,
	        I.CATEGORY,
	        UI.UI_ID,
	        UI.USER_ID,
	        UI.ACQUIRED_AT,
	        UI.IS_EQUIPPED,
	        UI.EQUIPPED_AT,
	        UI.PRICE AS USER_ITEM_PRICE,
	        UI.CATEGORY AS USER_ITEM_CATEGORY
	    FROM ITEM I
	    LEFT JOIN USER_ITEMS UI
	        ON I.ITEM_ID = UI.ITEM_ID
	       AND UI.USER_ID = #{userId}
	    WHERE I.ITEM_ID = #{itemId}
	</select>
	
	
	<!-- 보유중인 아이템 수 조회 -->
	<select id="itemCount" parameterType="int" resultType="int">
		SELECT COUNT(*)
		FROM USER_ITEMS
		WHERE USER_ID = #{memberId}
	</select>
	
	<!-- 카테고리별 아이템 조회 -->
	<select id="itemCategories" parameterType="string" resultType="ItemVO">
		SELECT
		ITEM_ID AS itemId,
		NAME AS itemName,
		DESCRIPTION,
		PRICE,
		RARITY,
		IS_ON_SALE AS isOnSale,
		CATEGORY,
		CREATED_AT AS createdAt,
		UPDATED_AT AS updatedAt
		FROM ITEM
		WHERE CATEGORY = #{category}
	</select>

  	
  	<!-- 포인트상점 아이템 구매 -->
  	<insert id="buyItem" parameterType="UserItemsVO">
	    INSERT INTO USER_ITEMS (
	        UI_ID,
	        ITEM_ID,
	        USER_ID,
	        ACQUIRED_AT,
	        IS_EQUIPPED,
	        PRICE,
	        CATEGORY
	    ) VALUES (
	        #{uiId},
	        #{itemId},
	        #{userId},
	        SYSDATE,
	        'N',
	        #{price},
	        #{category}
	    )
	</insert>

	<select id="randomPull" parameterType="string" resultType="ItemVO">
		SELECT * FROM (
			SELECT
				ITEM_ID as itemId,
				NAME as itemName,
				DESCRIPTION as description,
				PRICE as price,
				RARITY as rarity,
				IS_ON_SALE as isOnSale,
				CATEGORY as category
			FROM ITEM
			WHERE RARITY = #{rarity}
			ORDER BY DBMS_RANDOM.VALUE
		)
		WHERE ROWNUM = 1
	</select>
		
	<insert id="itemMapper.insertItemToMember" parameterType="com.kh.spring.item.model.vo.RandomPullHistory">
		INSERT INTO USER_ITEMS (
			UI_ID,
			ITEM_ID,
			USER_ID,
			PRICE,
			ACQUIRED_AT,
			IS_EQUIPPED
			) VALUES (
				SEQ_UI_ID.NEXTVAL,
				#{itemId},
				#{memberId},
				#{price},
				SYSDATE,
				'N'
				)
	</insert>

  	
  
</mapper>