<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.kh.spring.attendance.mapper.AttendanceMapper">

    <resultMap id="attendanceResultMap" type="com.kh.spring.attendance.model.vo.Attendance">
        <id property="attendanceId" column="ATTENDANCE_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="attendanceDate" column="ATTENDANCE_DATE"/>
        <result property="consecutiveDays" column="CONSECUTIVE_DAYS"/>
        <result property="pointsEarned" column="POINTS_EARNED"/>
    </resultMap>

    <!-- 오늘 출석 여부 확인 -->
    <select id="countAttendanceToday" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM ATTENDANCE
        WHERE USER_ID = #{memberId}
        AND TRUNC(ATTENDANCE_DATE) = TRUNC(SYSDATE)
    </select>

    <!-- 가장 최근 출석 기록 조회 -->
    <select id="findLastAttendanceByUserId" parameterType="int" resultMap="attendanceResultMap">
        SELECT *
        FROM (
            SELECT *
            FROM ATTENDANCE
            WHERE USER_ID = #{memberId}
            ORDER BY ATTENDANCE_DATE DESC
        )
        WHERE ROWNUM = 1
    </select>

    <!-- 출석 기록 저장 -->
    <insert id="insertAttendance" parameterType="com.kh.spring.attendance.model.vo.Attendance">
        INSERT INTO ATTENDANCE (
            ATTENDANCE_ID,
            USER_ID,
            ATTENDANCE_DATE,
            CONSECUTIVE_DAYS,
            POINTS_EARNED
        ) VALUES (
            SEQ_ATTENDANCE_ID.NEXTVAL,
            #{userId},
            SYSDATE,
            #{consecutiveDays},
            #{pointsEarned}
        )
    </insert>

    <!-- 포인트 지급 (POINT_WALLET 업데이트) -->
    <update id="updatePoint" parameterType="map">
        UPDATE POINT_WALLET
        SET NOW_POINT = NOW_POINT + #{points},
            UPDATED_AT = SYSDATE
        WHERE MEMBER_ID = #{memberId}
    </update>

    <!-- 이번 달 출석 기록 조회 -->
    <select id="findAttendanceHistoryByMonth" parameterType="map" resultMap="attendanceResultMap">
        SELECT *
        FROM ATTENDANCE
        WHERE USER_ID = #{memberId}
        AND TO_CHAR(ATTENDANCE_DATE, 'YYYY-MM') = #{yearMonth}
        ORDER BY ATTENDANCE_DATE ASC
    </select>

</mapper>
