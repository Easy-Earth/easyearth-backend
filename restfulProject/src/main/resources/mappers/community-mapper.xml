<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace = "communityMapper">

	<resultMap id="communityPostResultSet" type="CommunityPostVO">
        <id column="POST_ID" property="postId"/>
        <result column="MEMBER_ID" property="memberId"/>
        <result column="TITLE" property="title"/>
        <result column="CONTENT" property="content"/>
        <result column="CATEGORY" property="category"/>
        <result column="HAS_FILES" property="hasFiles"/>
        <result column="CREATE_AT" property="createAt"/>
        
        <!-- 1 : N 관계인 첨부파일 처리 -->
        <collection property="fileList" ofType="PostFilesVO" javaType="ArrayList">
            <id column="FILES_ID" property="filesId"/>
            <result column="POST_ID" property="postId"/>
            <result column="ORIGIN_NAME" property="originName"/>
            <result column="CHANGE_NAME" property="changeName"/>
            <result column="CREATE_AT" property="fileCreateAt"/>
        </collection>
    </resultMap>

	<!-- 게시글 총 개수 -->
	<select id="listCount" resultType="_int">
		SELECT COUNT(*)
		FROM COMMUNITY_POST
	</select>
	
	<!-- 검색된 게시글 개수 -->
	<select id="searchListCount" resultType="_int">
		SELECT COUNT(*)
		FROM COMMUNITY_POST
		<choose>
			<when test="condition == 'title'">
				WHERE TITLE LIKE '%' || #{keyword} || '%'
			</when>
			<when test="condition == 'writer'">
				WHERE MEMBER_ID = #{keyword}
			</when>
			<otherwise>
				WHERE CONTENT LIKE '%' || #{keyword} || '%'
			</otherwise>
		</choose>
	</select>
	
	<!-- 필터링된 게시글 개수 -->
	<select id="filterListCount" resultType="_int">
		SELECT COUNT(*)
		FROM COMMUNITY_POST
		WHERE CATEGORY = #{category}
	</select>
	
	<!-- 게시글 목록 조회 -->
	<select id="communityList" resultType="CommunityPostVO">
		SELECT POST_ID
 			  ,MEMBER_ID
 			  ,TITLE
			  ,VIEW_COUNT
			  ,LIKE_COUNT
			  ,COMMENT_COUNT
			  ,CREATED_AT
 			  ,CATEGORY
		FROM COMMUNITY_POST
		ORDER BY UPDATED_AT DESC
	</select>
	
	<!-- 게시글 검색 조회 -->
	<select id="searchList" resultType="CommunityPostVO" parameterType="hashmap">
		SELECT POST_ID
 			  ,MEMBER_ID
 			  ,TITLE
			  ,VIEW_COUNT
			  ,LIKE_COUNT
			  ,COMMENT_COUNT
			  ,CREATED_AT
 			  ,CATEGORY
		FROM COMMUNITY_POST
		<choose>
			<when test="condition == 'title'">
				WHERE TITLE LIKE '%' || #{keyword} || '%'
			</when>
			<when test="condition == 'writer'">
				WHERE MEMBER_ID = #{keyword}
			</when>
			<otherwise>
				WHERE CONTENT LIKE '%' || #{keyword} || '%'
			</otherwise>
		</choose>
		ORDER BY UPDATED_AT DESC
	</select>
	
	<!-- 게시글 필터링 조회 -->
	<select id="filterList" resultType="CommunityPostVO" parameterType="hashmap">
		SELECT POST_ID
 			  ,MEMBER_ID
 			  ,TITLE
			  ,VIEW_COUNT
			  ,LIKE_COUNT
			  ,COMMENT_COUNT
			  ,CREATED_AT
 			  ,CATEGORY
		FROM COMMUNITY_POST
		WHERE CATEGORY = #{category}
		ORDER BY UPDATED_AT DESC
	</select>
	
 	<!-- 게시글 상세보기 -->
 	<select id="communityDetail" parameterType="_int" resultType="CommunityPostVO">
 		SELECT POST_ID
 				,MEMBER_ID
 				,TITLE
 				,CONTENT
 				,VIEW_COUNT
 				,LIKE_COUNT
 				,UPDATED_AT
 				,CATEGORY
 				,ORIGIN_NAME
 				,CHANGE_NAME
 		FROM COMMUNITY_POST
 		WHERE POST_ID = #{postId}
 	</select>
 	
 	<!-- 게시글 등록 -->
 	<insert id="communityInsert" parameterType="CommunityPostVO">
 		<selectKey keyProperty = "postId" resultType = "int" order = "BEFORE">
 			SELECT POST_ID_SEQ.NEXTVAL FROM DUAL
 		</selectKey>
 		INSERT INTO
 		COMMUNITY_POST(
 			POST_ID
 			,MEMBER_ID
 			,TITLE
 			,CONTENT
 			,HAS_FILES
 			,CATEGORY
 		)VALUES(
 			#{postId}
 			,#{memberId}
 			,#{title}
 			,#{content}
 			,#{hasFiles}
 			,#{category}
 		)	
 	</insert>
 	
 	<!-- 첨부파일 추가 -->
 	<insert id="insertPostFile">
 		INSERT INTO POST_FILES (
 			FILES_ID
 			,POST_ID
 			,MEMBER_ID
 			,URL
 			,TYPE
 			,FILE_SIZE
 			,CREATED_AT
 			,ORIGIN_NAME
 			,CHANGE_NAME
 		)
 		SELECT FILES_ID_SEQ.NEXTVAL, A.* FROM (
 			<foreach collection = "list" item = "pf" separator = "UNION ALL">
 				SELECT #{pf.postId}
 					  ,#{pf.memberId}
 					  ,#{pf.url}
 					  ,#{pf.type}
 					  ,#{pf.fileSize}
 					  ,SYSDATE
 					  ,#{pf.originName}
 					  ,#{pf.changeName}
 				FROM DUAL
 			</foreach>
 		) A
 	</insert>
 	
 	<!-- 첨부파일 목록 -->
 	<select id="postFileList" resultType="PostFilesVO">
 		SELECT POST_ID
 			  ,ORIGIN_NAME
 			  ,CHANGE_NAME
 		FROM POST_FILES
 		WHERE POST_ID_SEQ = #{postId}
 		ORDER BY FILES_ID
 	</select>
 	
 	<!-- 게시글 수정 -->
 	<update id="communityUpdate" parameterType="CommunityPostVO">
 		UPDATE COMMUNITY_POST
 		SET
		POST_ID = #{postId}
		,MEMBER_ID = #{memberId}
 		,TITLE = #{title}
 		,CONTENT = #{content}
 		,HAS_FILES = #{hasFiles}
 		,UPDATED_AT = SYSDATE
 		,CATEGORY = #{category}

 	</update>
 	
 	<!-- 게시글 수정 - 삭제할 첨부파일 -->
 	<select id="selectOldFile" resultType="PostFilesVO">
 		SELECT FILES_ID
 				,CHANGE_NAME 
 		FROM POST_FILES
 		WHERE FILES_ID = #{filesId}
 	</select>
 	
 	<!-- 게시글 수정 - 선택한 첨부파일 삭제 -->
 	<delete id="deleteOldFile">
 		DELETE FROM POST_FILES
 		WHERE 
 		FILES_ID = #{filesId}
 	</delete>
 
 	<!-- 게시글 수정 - 텍스트 정보 수정 -->
    <update id="updatePost" parameterType="CommunityPostVO">
        UPDATE COMMUNITY_POST
        SET TITLE = #{title},
            CONTENT = #{content},
            CATEGORY = #{category},
            UPDATED_AT = SYSDATE
        WHERE POST_ID = #{postId}
          AND MEMBER_ID = #{memberId}
    </update>

    <!-- 게시글 수정 - 삭제 대상 파일 조회 -->
    <select id="selectFilesByIds" parameterType="map" resultType="PostFilesVO">
        SELECT FILES_ID,
               POST_ID,
               MEMBER_ID,
               URL,
               ORIGIN_NAME,
               CHANGE_NAME,
               TYPE,
               FILE_SIZE,
               CREATED_AT
        FROM POST_FILES
        WHERE POST_ID = #{postId}
          AND FILES_ID IN
          <foreach collection="delFileIds" item="id" open="(" separator="," close=")">
              #{id}
          </foreach>
    </select>

    <!-- 게시글 수정 - 실제 파일 데이터 삭제 -->
    <delete id="deleteFilesByIds" parameterType="map">
        DELETE FROM POST_FILES
        WHERE POST_ID = #{postId}
          AND FILES_ID IN
          <foreach collection="delFileIds" item="id" open="(" separator="," close=")">
              #{id}
          </foreach>
    </delete>

    <!-- 해당 게시글 파일 개수 -->
    <select id="countFilesByPostId" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM POST_FILES
        WHERE POST_ID = #{postId}
    </select>

    <!-- 게시글 수정 - 파일 첨부 여부 갱신 -->
    <update id="updateHasFiles" parameterType="map">
        UPDATE COMMUNITY_POST
        SET HAS_FILES = #{hasFiles},
            UPDATED_AT = SYSDATE
        WHERE POST_ID = #{postId}
    </update>

	<!-- 게시글 첨부파일 목록 조회 -->
 	<select id="selectFilesByPostIds" parameterType="_int" resultType="PostFilesVO">
		SELECT FILES_ID
			  ,POST_ID
			  ,MEMBER_ID
			  ,URL
			  ,ORIGIN_NAME
			  ,CHANGE_NAME
			  ,TYPE
			  ,FILE_SIZE
			  ,CREATED_AT
		FROM POST_FILES
		WHERE POST_ID = #{postId}
		ORDER BY FILES_ID ASC
 	</select>
 	
 	<!-- 게시글 삭제 -->
 	<delete id="communityDelete" parameterType="_int">
 		DELETE FROM COMMUNITY_POST
 		WHERE
 		POST_ID = #{postId}
 	</delete>
 	
	<!-- 게시글 조회수 증가 -->
	<update id="increaseViewCount" parameterType="_int">
		UPDATE COMMUNITY_POST
		SET VIEW_COUNT = VIEW_COUNT + 1
		WHERE POST_ID = #{postId}
	</update> 
 	
</mapper>
