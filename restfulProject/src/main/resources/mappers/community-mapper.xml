<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace = "communityMapper">

	<resultMap id="communityPostResultSet" type="CommunityPostVO">
        <id column="POST_ID" property="postId"/>
        <result column="MEMBER_ID" property="memberId"/>
        <result column="TITLE" property="title"/>
        <result column="CONTENT" property="content"/>
        <result column="CATEGORY" property="category"/>
        <result column="HAS_FILES" property="hasFiles"/>
        <result column="CREATE_AT" property="createAt"/>
        
        <!-- 1 : N 관계인 첨부파일 처리 -->
        <collection property="fileList" ofType="PostFilesVO" javaType="ArrayList">
            <id column="FILES_ID" property="filesId"/>
            <result column="POST_ID" property="postId"/>
            <result column="ORIGIN_NAME" property="originName"/>
            <result column="CHANGE_NAME" property="changeName"/>
            <result column="CREATE_AT" property="fileCreateAt"/>
        </collection>
    </resultMap>

	<!-- 게시글 총 개수 -->
	<select id="listCount" resultType="_int">
		SELECT COUNT(*)
		FROM COMMUNITY_POST
	</select>
	
	<!-- 검색된 게시글 개수 -->
	<select id="searchListCount" resultType="_int">
		SELECT COUNT(*)
		FROM COMMUNITY_POST
		<choose>
			<when test="condition == 'title'">
				WHERE TITLE LIKE '%' || #{keyword} || '%'
			</when>
			<when test="condition == 'writer'">
				WHERE MEMBER_ID = #{keyword}
			</when>
			<otherwise>
				WHERE CONTENT LIKE '%' || #{keyword} || '%'
			</otherwise>
		</choose>
	</select>
	
	<!-- 필터링된 게시글 개수 -->
	<select id="filterListCount" resultType="_int">
		SELECT COUNT(*)
		FROM COMMUNITY_POST
		WHERE CATEGORY = #{category}
	</select>
	
	<!-- 게시글 목록 조회 -->
	<select id="communityList" resultType="CommunityPostVO">
		SELECT POST_ID
 			  ,MEMBER_ID
 			  ,TITLE
			  ,VIEW_COUNT
			  ,LIKE_COUNT
			  ,COMMENT_COUNT
			  ,CREATED_AT
 			  ,CATEGORY
		FROM COMMUNITY_POST
		ORDER BY UPDATED_AT DESC
	</select>
	
	<!-- 게시글 검색 조회 -->
	<select id="searchList" resultType="CommunityPostVO" parameterType="hashmap">
		SELECT POST_ID
 			  ,MEMBER_ID
 			  ,TITLE
			  ,VIEW_COUNT
			  ,LIKE_COUNT
			  ,COMMENT_COUNT
			  ,CREATED_AT
 			  ,CATEGORY
		FROM COMMUNITY_POST
		<choose>
			<when test="condition == 'title'">
				WHERE TITLE LIKE '%' || #{keyword} || '%'
			</when>
			<when test="condition == 'writer'">
				WHERE MEMBER_ID = #{keyword}
			</when>
			<otherwise>
				WHERE CONTENT LIKE '%' || #{keyword} || '%'
			</otherwise>
		</choose>
		ORDER BY UPDATED_AT DESC
	</select>
	
	<!-- 게시글 필터링 조회 -->
	<select id="filterList" resultType="CommunityPostVO" parameterType="hashmap">
		SELECT POST_ID
 			  ,MEMBER_ID
 			  ,TITLE
			  ,VIEW_COUNT
			  ,LIKE_COUNT
			  ,COMMENT_COUNT
			  ,CREATED_AT
 			  ,CATEGORY
		FROM COMMUNITY_POST
		WHERE CATEGORY = #{category}
		ORDER BY UPDATED_AT DESC
	</select>
	
 	<!-- 게시글 상세보기 -->
 	<select id="communityDetail" parameterType="_int" resultType="CommunityPostVO">
 		SELECT POST_ID
 				,MEMBER_ID
 				,TITLE
 				,CONTENT
 				,VIEW_COUNT
 				,LIKE_COUNT
 				,UPDATED_AT
 				,CATEGORY
 				,ORIGIN_NAME
 				,CHANGE_NAME
 		FROM COMMUNITY_POST
 		WHERE POST_ID = #{postId}
 	</select>
 	
 	<!-- 게시글 등록 -->
 	<insert id="communityInsert" parameterType="CommunityPostVO">
 		<selectKey keyProperty = "postId" resultType = "int" order = "BEFORE">
 			SELECT POST_ID_SEQ.NEXTVAL FROM DUAL
 		</selectKey>
 		INSERT INTO
 		COMMUNITY_POST(
 			POST_ID
 			,MEMBER_ID
 			,TITLE
 			,CONTENT
 			,HAS_FILES
 			,CATEGORY
 		)VALUES(
 			#{postId}
 			,#{memberId}
 			,#{title}
 			,#{content}
 			,#{hasFiles}
 			,#{category}
 		)	
 	</insert>
 	
 	<!-- 첨부파일 추가 -->
 	<insert id="insertPostFile">
 		INSERT INTO POST_FILES (
 			FILES_ID
 			,POST_ID
 			,MEMBER_ID
 			,URL
 			,TYPE
 			,FILE_SIZE
 			,CREATED_AT
 			,ORIGIN_NAME
 			,CHANGE_NAME
 		)
 		SELECT FILES_ID_SEQ.NEXTVAL, A.* FROM (
 			<foreach collection = "list" item = "pf" separator = "UNION ALL">
 				SELECT #{pf.postId}
 					  ,#{pf.memberId}
 					  ,#{pf.url}
 					  ,#{pf.type}
 					  ,#{pf.fileSize}
 					  ,SYSDATE
 					  ,#{pf.originName}
 					  ,#{pf.changeName}
 				FROM DUAL
 			</foreach>
 		) A
 	</insert>
 
 	<!-- 게시글 수정 - 텍스트 정보 수정 -->
    <update id="updatePost" parameterType="CommunityPostVO">
        UPDATE COMMUNITY_POST
        SET TITLE = #{title},
            CONTENT = #{content},
            CATEGORY = #{category},
            UPDATED_AT = SYSDATE
        WHERE POST_ID = #{postId}
          AND MEMBER_ID = #{memberId}
    </update>

    <!-- 게시글 수정 - 삭제 대상 파일 조회 -->
    <select id="selectFilesByIds" parameterType="map" resultType="PostFilesVO">
        SELECT FILES_ID,
               POST_ID,
               MEMBER_ID,
               URL,
               ORIGIN_NAME,
               CHANGE_NAME,
               TYPE,
               FILE_SIZE,
               CREATED_AT
        FROM POST_FILES
        WHERE POST_ID = #{postId}
          AND FILES_ID IN
          <foreach collection="delFileIds" item="id" open="(" separator="," close=")">
              #{id}
          </foreach>
    </select>

    <!-- 게시글 수정 - 실제 파일 데이터 삭제 -->
    <delete id="deleteFilesByIds" parameterType="map">
        DELETE FROM POST_FILES
        WHERE POST_ID = #{postId}
          AND FILES_ID IN
          <foreach collection="delFileIds" item="id" open="(" separator="," close=")">
              #{id}
          </foreach>
    </delete>

    <!-- 해당 게시글 파일 개수 -->
    <select id="countFilesByPostId" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM POST_FILES
        WHERE POST_ID = #{postId}
    </select>

    <!-- 게시글 수정 - 파일 첨부 여부 갱신 -->
    <update id="updateHasFiles" parameterType="map">
        UPDATE COMMUNITY_POST
        SET HAS_FILES = #{hasFiles},
            UPDATED_AT = SYSDATE
        WHERE POST_ID = #{postId}
    </update>

	<!-- 게시글 첨부파일 목록 조회 -->
 	<select id="selectFilesByPostIds" parameterType="_int" resultType="PostFilesVO">
		SELECT FILES_ID
			  ,POST_ID
			  ,MEMBER_ID
			  ,URL
			  ,ORIGIN_NAME
			  ,CHANGE_NAME
			  ,TYPE
			  ,FILE_SIZE
			  ,CREATED_AT
		FROM POST_FILES
		WHERE POST_ID = #{postId}
		ORDER BY FILES_ID ASC
 	</select>
 	
 	<!-- 게시글 삭제 -->
 	<delete id="communityDelete" parameterType="_int">
 		DELETE FROM COMMUNITY_POST
 		WHERE
 		POST_ID = #{postId}
 	</delete>
 	
	<!-- 게시글 조회수 증가 -->
	<update id="increaseViewCount" parameterType="_int">
		UPDATE COMMUNITY_POST
		SET VIEW_COUNT = VIEW_COUNT + 1
		WHERE POST_ID = #{postId}
	</update> 
	
	<!-- 댓글 목록 조회 -->
	<select id="replyList" parameterType="_int" resultType="CommunityReplyVO">
		SELECT R.REPLY_ID
			  ,R.POST_ID
			  ,R.MEMBER_ID
			  ,CASE
			  	WHEN R.STATUS = 'N' THEN TO_CLOB('삭제된 댓글입니다.')
			  	ELSE R.CONTENT
			  END AS CONTENT
			  ,R.PARENT_REPLY_ID
			  ,R.GROUP_ID
			  ,R.DEPTH
			  ,R.UPDATED_AT
			  ,R.STATUS
		FROM COMMUNITY_REPLY R
		JOIN MEMBER M ON R.MEMBER_ID = M.MEMBER_ID
		WHERE R.POST_ID = #{postId}
		ORDER BY R.GROUP_ID DESC,
				 R.REPLY_ID ASC
			  
	</select>
	
	<!-- 부모 댓글 정보 조회  -->
	<select id="selectParentReply" parameterType="_int" resultType="CommunityReplyVO">
		SELECT * 
		FROM COMMUNITY_REPLY 
		WHERE REPLY_ID = #{replyId}
	</select>
	
	<!-- 댓글 등록 -->
	<insert id="replyInsert" parameterType="CommunityReplyVO">
		<selectKey keyProperty="replyId" resultType="_int" order="BEFORE">
			SELECT REPLY_ID_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO 
		COMMUNITY_REPLY (REPLY_ID
						,POST_ID
						,MEMBER_ID
						,PARENT_REPLY_ID
						,CONTENT
						,GROUP_ID
						,DEPTH
						,STATUS
		) VALUES ( #{replyId}
				  ,#{postId}
				  ,#{memberId}
				  ,
				  <choose>
				  	<when test="parentReplyId == 0">NULL</when>
				  	<otherwise>#{parentReplyId}</otherwise>
				  </choose>
				  ,#{content}
				  ,
				  <choose>
				  	<when test="parentReplyId != 0">#{groupId}</when>
				  	<otherwise>#{replyId}</otherwise>
				  </choose>
				  ,#{depth}
				  ,'Y'
		)
	</insert>
	
	<!-- 댓글 수정 -->
	<update id="replyUpdate" parameterType="CommunityReplyVO">
		UPDATE COMMUNITY_REPLY
		SET CONTENT = #{content}
		WHERE REPLY_ID = #{replyId}
		AND MEMBER_ID = #{memberId}
	</update>
	
	<!-- 댓글 삭제 -->
 	<update id="replyDelete" parameterType="CommunityReplyVO">
 		UPDATE COMMUNITY_REPLY
 		SET STATUS = 'N'
 		WHERE REPLY_ID = #{replyId}
 		AND MEMBER_ID = #{memberId}
 	</update>
 		
	<!-- 이미 좋아요를 누른 게시글인지 확인 -->
	<select id="checkPostLike" parameterType="map" resultType="_int">
		SELECT COUNT(*)
		FROM COMMUNITY_POST_LIKES
		WHERE POST_ID = #{postId}
		AND MEMBER_ID = #{memberId}
	</select>
	
	<!-- 게시글 좋아요 등록 -->
 	<insert id="insertPostLike" parameterType="map">
 		INSERT INTO 
 		COMMUNITY_POST_LIKES (
 			PL_ID
 			,POST_ID
 			,MEMBER_ID
 			,CREATED_AT
 			,STATUS
 		) VALUES (
 			PL_ID_SEQ.NEXTVAL
 			,#{postId}
 			,#{memberId}
 			,SYSDATE
 			,'Y'
 		)
 	</insert>
 		
	<!-- 게시글 좋아요 상태 변경 -->
	<update id="changePostLike" parameterType="map">
		UPDATE COMMUNITY_POST_LIKES
		SET STATUS = DECODE(STATUS, 'Y', 'N', 'Y')
		WHERE POST_ID = #{postId}
		AND MEMBER_ID = #{memberId}
	</update>
 	
 	<!-- 이미 좋아요를 누른 댓글인지 확인 -->
	<select id="checkReplyLike" parameterType="map" resultType="_int">
		SELECT COUNT(*)
		FROM COMMUNITY_REPLY_LIKES
		WHERE REPLY_ID = #{replyId}
		AND POST_ID = #{postId}
		AND MEMBER_ID = #{memberId}
	</select>
	
	<!-- 댓글 좋아요 등록 -->
 	<insert id="insertReplyLike" parameterType="map">
 		INSERT INTO 
 		COMMUNITY_REPLY_LIKES (
 			RL_ID
 			,REPLY_ID
 			,POST_ID
 			,MEMBER_ID
 			,CREATED_AT
 			,STATUS
 		) VALUES (
 			RL_ID_SEQ.NEXTVAL
 			,#{replyId}
 			,#{postId}
 			,#{memberId}
 			,SYSDATE
 			,'Y'
 		)
 	</insert>
 		
	<!-- 댓글 좋아요 상태 변경 -->
	<update id="changeReplyLike" parameterType="map">
		UPDATE COMMUNITY_REPLY_LIKES
		SET STATUS = DECODE(STATUS, 'Y', 'N', 'Y')
		WHERE REPLY_ID = #{replyId} 
		AND POST_ID = #{postId}
		AND MEMBER_ID = #{memberId}
	</update>
 	
</mapper>
