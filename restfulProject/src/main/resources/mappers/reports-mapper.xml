<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace = "reportsMapper">

	<!-- 신고글 전체 개수 -->
	<select id="reportListsCount" resultType="_int">
		SELECT COUNT(*) 
		FROM REPORTS
	</select>
	
	<!-- 검색된 신고글 개수 -->
	<select id="searchReportsCount" parameterType="hashmap" resultType="_int">
		SELECT COUNT(*)
		FROM REPORTS
		<choose>
			<when test="condition == 'memberId'">
				WHERE MEMBER_ID = #{keyword}
			</when>
			<when test="condition == 'targetMemberId'">
				WHERE TARGET_MEMBER_ID = #{keyword}
			</when>
			<otherwise>
				WHERE DETAIL LIKE '%' || #{keyword} || '%'
			</otherwise>
		</choose>
	</select>
	
	<!-- 필터링된 신고글 개수 -->
	<select id="filterReportsCount" parameterType="hashmap" resultType="_int">
		SELECT COUNT(*)
		FROM REPORTS
		<where>
	        <if test="type">
	            AND TYPE = #{type}
	        </if>
	        <if test="status">
	            AND STATUS = #{status}
	        </if>
    	</where>
	</select>
	
	<!-- 신고글 목록 조회 -->
	<select id="reportsList" resultType="ReportsVO">
		SELECT REPORTS_ID
			  ,MEMBER_ID
			  ,TARGET_MEMBER_ID
			  ,POST_ID
			  ,REPLY_ID
			  ,REVIEW_ID
			  ,TYPE
			  ,REASON
			  ,STATUS
			  ,CREATED_AT
			  ,RESOLVED_AT
		FROM REPORTS
		ORDER BY CREATED_AT DESC
	</select>
	
	<!-- 신고글 검색 조회 -->
	<select id="searchReportsList" parameterType="hashmap" resultType="ReportsVO">
		SELECT REPORTS_ID
			  ,MEMBER_ID
			  ,TARGET_MEMBER_ID
			  ,POST_ID
			  ,REPLY_ID
			  ,REVIEW_ID
			  ,TYPE
			  ,REASON
			  ,STATUS
			  ,CREATED_AT
			  ,RESOLVED_AT
		FROM REPORTS
		<choose>
			<when test="condition == 'memberId'">
				WHERE MEMBER_ID = #{keyword}
			</when>
			<when test="condition == 'targetMemberId'">
				WHERE TARGET_MEMBER_ID = #{keyword}
			</when>
			<otherwise>
				WHERE DETAIL LIKE '%' || #{keyword} || '%'
			</otherwise>
		</choose>
		ORDER BY CREATED_AT DESC
	</select>
	
	<!-- 신고글 필터링 조회 -->
	<select id="filterReportsList" parameterType="hashmap" resultType="ReportsVO">
		SELECT REPORTS_ID
			  ,MEMBER_ID
			  ,TARGET_MEMBER_ID
			  ,POST_ID
			  ,REPLY_ID
			  ,REVIEW_ID
			  ,TYPE
			  ,REASON
			  ,STATUS
			  ,CREATED_AT
			  ,RESOLVED_AT
		FROM REPORTS
		<where>
	        <if test="type">
	            AND TYPE = #{type}
	        </if>
	        <if test="status">
	            AND STATUS = #{status}
	        </if>
	    </where>
    	ORDER BY CREATED_AT DESC
	</select>
	
	<!-- 신고 등록 -->
	<insert id="reportsInsert" parameterType="map">
		INSERT INTO REPORTS (
			REPORTS_ID
			,MEMBER_ID
			,TARGET_MEMBER_ID
			,TYPE
			,POST_ID
			,REPLY_ID
			,REVIEW_ID
			,REASON
			,DETAIL
		) VALUES (
			REPORTS_ID_SEQ.NEXTVAL
			,#{memberId}
			,#{targetMemberId}
			,#{type}
			,<choose>
	            <when test="postId == 0">NULL</when>
	            <otherwise>#{postId}</otherwise>
	        </choose>,
	        <choose>
	            <when test="replyId == 0">NULL</when>
	            <otherwise>#{replyId}</otherwise>
	        </choose>,
	        <choose>
	            <when test="reviewId == 0">NULL</when>
	            <otherwise>#{reviewId}</otherwise>
	        </choose>
			,#{reason}
			,#{detail}
		)
	</insert>

	<!-- 누적 신고 수 -->
	<select id="reportsCount" parameterType="map" resultType="_int">
		SELECT COUNT(*) FROM REPORTS
		<where>
			<if test="type == 'POST'">AND POST_ID = #{postId}</if>
			<if test="type == 'REPLY'">AND REPLY_ID = #{replyId}</if>
			<if test="type == 'REVIEW'">AND REVIEW_ID = #{reviewId}</if>
		</where>
	</select>
	
	<!-- 10회 이상 신고 - status : N 처리 -->
 	<update id="disableTarget" parameterType="map">
 		<choose>
 			<when test="type == 'POST'">
 				UPDATE COMMUNITY_POST SET STATUS = 'N' WHERE POST_ID = #{postId}
 			</when>
			<when test="type == 'REPLY'">
 				UPDATE COMMUNITY_REPLY SET STATUS = 'N' WHERE REPLY_ID = #{replyId}
 			</when>
 			<when test="type == 'POST'">
 				UPDATE ECO_SHOP_REVIEW SET STATUS = 'N' WHERE ESR_ID = #{reviewId}
 			</when>	
 		</choose>
 	</update>
 	
 	<!-- 신고 수정 -->
 	<update id="reportsUpdate" parameterType="ReportsVO">
 		UPDATE REPORTS
 		SET REASON = #{reason}
 			,DETAIL = #{detail}
 		WHERE REPORTS_ID = #{reportsId}
 		AND MEMBER_ID = #{memberId}
 		AND STATUS IS NULL
 	</update>
 	
 	<!-- 신고 삭제 -->
 	<delete id="reportsDelete" parameterType="_int">
 		DELETE FROM REPORTS
 		WHERE REPORTS_ID = #{reportsId}
 		AND MEMBER_ID = #{memberId}
 		AND STATUS IS NULL
 	</delete>
 	
 	
 	
 	
 	
</mapper>
